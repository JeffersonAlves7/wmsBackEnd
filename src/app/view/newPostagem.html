<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="http://github.com/JeffersonAlves7">
  <meta name="description" content="Feito com o objetivo de enviar números de pedidos ao sistema">
  <title>PostArea</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
  <!-- development version, includes helpful console warnings -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <style>
    .transition-all {
      transition: all ease-in-out .3s;
    }
  </style>
</head>

<body>
  <main>
    <nav class="navbar bg-light fixed-top">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Controlador</span>
        <div style="gap: .8rem" class="d-flex align-items-center">
          <a class="nav-link" href="#enviarPedidos">Enviar Pedidos</a>
          <a class="nav-link" href="#buscarPedidos">Buscar Pedidos</a>
        </div>
      </div>
    </nav>
    <main style="grid-auto-rows: 100vh;" class="container d-grid">
      <section id="enviarPedidos" class="row align-items-center justify-content-center">
        <main>
          <div class="row">
            <div class="col">
              <h1 class="text-center">Enviar pedidos para o WMS</h1>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="d-flex flex-column">
                <div v-if="success.hasSuccess" class="alert alert-success" id="complete">
                  <p class="mb-0">{{success.message}}</p>
                </div>
                <div v-if="error.hasError" class="alert alert-danger">
                  <p class="mb-0">{{error.message}}</p>
                </div>
              </div>
              <div style="margin-bottom: 20px;" class="form-floating">
                <textarea id="textArea" v-model="pedidos" class="form-control" placeholder="Insira os números"
                  id="floatingTextarea2" style="height: 100px"></textarea>
                <label for="floatingTextarea2">Insira os números</label>
              </div>
              <div style="gap: .8rem" class="d-flex align-items-center">
                <button class="btn btn-primary" v-on:click="sendPedido" type="button">Enviar</button>
                <div v-if="isLoading">
                  <p class="mb-0">Carregando...</p>
                </div>
              </div>
            </div>
          </div>
        </main>
      </section>
      <section id="buscarPedidos" class="row align-items-center justify-content-center">
        <main>
          <h1 class="text-center">Buscar e alterar pedidos</h1>
          <main style="margin-bottom: 2rem;" class="row">
            <div class="input-group">
              <input type="search" v-on:keyup.enter="getPedido" v-model="busca" class="form-control"
                placeholder="Buscar pedido" aria-label="Text input with segment">
              <button v-on:click="getPedido" class="btn btn-outline-secondary" type="button">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </main>
          <div v-if="pedidos.length > 0" style="overflow-y: scroll; max-height: 600px; padding: .5rem">
            <ul style="margin: 0 !important; padding: 0 !important;" class="row align-items-center flex-column gap-2">
              <li style="max-width: 950px; padding-top: .4rem; padding-bottom: .4rem;"
                class="pedidos bg-primary row rounded align-items-center justify-content-between"
                v-for="pedido in pedidos">
                <div class="text-light col d-flex align-items-center flex-column">
                  <p style="margin-bottom: 0;">NF</p>
                  <p style="margin-bottom: 0;">{{pedido.nf}}</p>
                </div>
                <div class="text-light col d-flex align-items-center flex-column">
                  <p class="text-light" style="margin-bottom: 0;">Pedido</p>
                  <small style="font-size: .65rem;">{{pedido.pedido}}</small>
                </div>
                <div class="text-light col d-flex align-items-center flex-column">
                  <p style="margin-bottom: 0;">Integração</p>
                  <p style="margin-bottom: 0;">{{pedido.integracao}}</p>
                </div>
                <div class="d-flex col text-light align-items-center flex-column">
                  <p class="text-light" style="margin-bottom: 0;">Situação</p>
                  <select class="form-select" aria-label="Situação do pedido">
                    <option :selected="isSelected(pedido, 'processando')" value="processando">Processando</option>
                    <option :selected="isSelected(pedido, 'emaberto')" value="emaberto">Em aberto</option>
                    <option :selected="isSelected(pedido, 'embalado')" value="embalado">Embalado</option>
                    <option :selected="isSelected(pedido, 'finalizado')" value="finalizado">Finalizado</option>
                  </select>
                </div>
                <div class="col d-flex gap-2">
                  <button class="btn btn-success">Alterar</button>
                  <button class="btn btn-danger" type="button">Apagar</button>
                </div>
              </li>
            </ul>
          </div>
        </main>
      </section>
    </main>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
    integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"
    integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK"
    crossorigin="anonymous"></script>
  <script>

    const enviar = new Vue({
      el: '#enviarPedidos',
      data: {
        pedidos: '',
        trated: '',
        isLoading: false,
        error: {
          hasError: false,
          message: ""
        },
        success: {
          hasSuccess: false,
          message: ""
        },
      },
      methods: {
        sendPedido() {
          this.isLoading = true

          //Just for simulate the sending proccess
          setTimeout(() => {
            this.isLoading = false
          }, 1000)
        },
        sendError(error){
          this.error = error
        },
      },
      watch: {
        pedidos(p) {
          const charsLen = 5
          const arr = p.trim().split(" ").filter(a => a.trim() !== "")
          this.sendError({hasError: false, message: ""})

          for (let i = 0; i < arr.length; i++) {
            const element = arr[i];
            if ( (i === arr.length - 1) && !(element.length <= 5)) {
              return this.sendError({hasError: true, message: "Números não foram inseridos corretamente"});
            } else if( i !== arr.length - 1 &&  element.length !== 5){
              return this.sendError({hasError: true, message: "Números não foram inseridos corretamente"});
            }
          }

          let trat = '['
          for (let i = 0; i < arr.length; i++) {
            i === (arr.length - 1) ? trat += `'${arr[i]}'` : trat += `'${arr[i]}',`
          };
          trat += ']';
          return this.trated = trat
        }
      }
    })

    const buscar = new Vue({
      el: '#buscarPedidos',
      data: {
        pedidos: [],
        busca: "",
        navOpen: false
      },
      methods: {
        async getPedido() {
          const { busca } = this
          if (busca.trim() == '') return this.pedidos = []
          try {
            const res = await fetch(`http://localhost:8083/pedidos/buscar?busca=${busca}`,
              { method: "GET", mode: 'cors' })
            const { response } = await res.json()
            if (!response) return this.pedidos = []
            this.pedidos = response
          } catch (e) {
            this.pedidos = []
          }
        },
        isSelected(pedido, situacao) { return pedido.situacao === situacao ? true : false },
      },
      watch: { 
        busca(e){
          if( e.trim() !== "") return
          this.pedidos = []
        }
      }
    })

  </script>
</body>

</html>